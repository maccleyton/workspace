<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Visualizar Documento -  Hub Markdown</title>
  <style>
    :root{
      --bg: #0f0f12; --panel:#15161a; --muted:#8b8f98; --text:#e9e9ef; --accent:#4f7cff; --border:#2a2c34;
      --toc: 300px; --sans: system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial,sans-serif;
    }
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:var(--sans)}
    .layout{ display:grid; grid-template-columns: var(--toc) 1fr; grid-template-rows: 100vh; width:100vw;height:100vh; overflow:hidden; }
    aside#toc{ background:var(--panel); border-right:1px solid var(--border); padding:12px 10px; overflow:auto; }
    .doc-toc { font-size: 0.94rem; line-height: 1.35; user-select:none; }
    .doc-toc .level-1 { margin-left: 0 }
    .doc-toc .level-2 { margin-left: 8px }
    .doc-toc .level-3 { margin-left: 16px }
    .doc-toc .level-4 { margin-left: 24px }
    .doc-toc .level-5 { margin-left: 32px }
    .doc-toc .level-6 { margin-left: 40px }
    .doc-toc a { cursor:pointer; display:block; padding:4px 6px; border-radius:6px; color:var(--text); text-decoration:none; }
    .doc-toc a:hover{ background:#1f2026 }
    main.preview{
      background:#0c0d11; color:#e6e6ee; overflow:auto; padding:22px; font-size:16px; line-height:1.6;
    }
    main.preview pre{ background:#0b0d12; border:1px solid #1e2230; border-radius:8px; padding:12px; overflow:auto }
    main.preview code{ background:#151821; padding:1px 4px; border-radius:4px }
    main.preview blockquote{ border-left:3px solid #3a3f52; margin:0.8em 0; padding:0.1em 0 0.1em 10px; color:#cdd1db }
    main.preview hr{ border:none; height:1px; background:#222532; margin:18px 0 }
    /* Preserva espaços de parágrafo/itens */
    main.preview p, main.preview li { white-space: pre-wrap; overflow-wrap:anywhere; }
    main.preview ul, main.preview ol { padding-left: 1.2em; margin: 0.4em 0; }
    main.preview li { margin: 0.2em 0; }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; grid-auto-rows:auto; }
      aside#toc, main.preview{ height:auto; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside id="toc"><div class="doc-toc" id="toc-content">Navegação</div></aside>
    <main id="md-preview" class="preview"></main>
  </div>

<script>
/* ======= Núcleo Markdown (mesmo de edit.html) ======= */
const MarkdownCore = (() => {
  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
  const CODE_PH = (i)=>`@@CODEBLOCK_${i}@@`;
  function extractCodeFences(src){
    const blocks=[]; let out='', i=0, pos=0;
    const re=/```([\s\S]*?)```
    while ((m=re.exec(src))){ out += src.slice(pos, m.index) + CODE_PH(i); blocks.push(m); pos = m.index + m.length; i++; }[1]
    out += src.slice(pos); return { out, blocks };
  }
  function restoreCodeFences(src, blocks){
    return src.replace(/@@CODEBLOCK_(\d+)@@/g, (_,k)=>`<pre><code>${escapeHtml(blocks[+k]||'')}</code></pre>`);
  }
  function slugify(t){ return t.toLowerCase().trim().replace(/[`~!@#$%^&*()+=$$$${}|\\;:'",.<>/?]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-'); }
  function parseNestedLists(md) {
    const lines = md.replace(/\r\n?/g, '\n').split('\n');
    const out = []; const stack = [];
    const bulletRE = /^(\s*)([-*+])\s+(.*)$/; const orderedRE = /^(\s*)(\d+)\.\s+(.*)$/;
    const openList=(t,i)=>{ out.push(`<${t}>`); stack.push({type:t,indent:i}); };
    const closeOne=()=>{ const s=stack.pop(); out.push(`</${s.type}>`); };
    const closeUntil=(i)=>{ while (stack.length && stack[stack.length-1].indent >= i) closeOne(); };
    for (let i=0;i<lines.length;i++){
      const line=lines[i]; const mB=line.match(bulletRE); const mO=line.match(orderedRE);
      if (mB||mO){
        const indent=((mB||mO)[1]||'').replace(/\t/g,'  ').length;
        const type=mB?'ul':'ol'; const text=(mB?mB:mO).trim();[3]
        if (!stack.length) openList(type,indent);
        else {
          const top=stack[stack.length-1];
          if (indent>top.indent) openList(type,indent);
          else if (indent<top.indent) closeUntil(indent);
          else if (top.type!==type){ closeOne(); openList(type,indent); }
        }
        out.push(`<li>${text}</li>`);
      } else {
        if (stack.length && (line.trim()==='' || /^[#>]/.test(line))) { while (stack.length) closeOne(); }
        out.push(line);
      }
    }
    while (stack.length) closeOne();
    return out.join('\n');
  }
  function mdToHtml(md){
    const ex = extractCodeFences(md);
    let s = parseNestedLists(ex.out);
    s = s.replace(/^###### (.*)$/gm,(m,t)=>`<h6 id="${slugify(t)}">${t}</h6>`)
         .replace(/^##### (.*)$/gm,(m,t)=>`<h5 id="${slugify(t)}">${t}</h5>`)
         .replace(/^#### (.*)$/gm,(m,t)=>`<h4 id="${slugify(t)}">${t}</h4>`)
         .replace(/^### (.*)$/gm,(m,t)=>`<h3 id="${slugify(t)}">${t}</h3>`)
         .replace(/^## (.*)$/gm,(m,t)=>`<h2 id="${slugify(t)}">${t}</h2>`)
         .replace(/^# (.*)$/gm,(m,t)=>`<h1 id="${slugify(t)}">${t}</h1>`);
    s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
    s = s.replace(/^\> (.*)$/gm,'<blockquote>$1</blockquote>');
    s = s.replace(/^\s*[-*_]{3,}\s*$/gm,'<hr/>');
    s = s.replace(/(^|\n)([^<\n][^\n]*)/g,(m,br,ln)=>{
      if (/^\s*$/.test(ln)) return m;
      if (/^\s*<\/?(h\d|ul|ol|li|pre|blockquote|hr)/.test(ln)) return m;
      return `${br}<p>${ln}</p>`;
    });
    s = restoreCodeFences(s, ex.blocks);
    return s;
  }
  function buildTOCFromHTML(root){
    const nodes = Array.from(root.querySelectorAll('h1,h2,h3,h4,h5,h6'));
    return nodes.map(h=>({ id:h.id|| (h.id = slugify(h.textContent)), text:h.textContent.trim(), level:+h.tagName.substring(1) }));
  }
  function tocHTML(toc){ return toc.length ? toc.map(it=>`<div class="level-${it.level}"><a data-id="${it.id}">${it.text}</a></div>`).join('') : '<div>Nenhum título encontrado</div>'; }
  return { mdToHtml, buildTOCFromHTML, tocHTML };
})();

/* ======= Renderização e TOC ======= */
const $preview = document.getElementById('md-preview');
const $toc = document.getElementById('toc-content');

function render(md){
  const html = MarkdownCore.mdToHtml(md);
  $preview.innerHTML = html;
  const toc = MarkdownCore.buildTOCFromHTML($preview);
  $toc.innerHTML = MarkdownCore.tocHTML(toc);
  bindTOCClicks();
}
function bindTOCClicks(){
  $toc.querySelectorAll('a[data-id]').forEach(a=>{
    a.onclick = () => {
      const id = a.getAttribute('data-id');
      const h = $preview.querySelector(`#${CSS.escape(id)}`);
      if (h) h.scrollIntoView({behavior:'smooth', block:'start'});
    };
  });
}

// Recebe documento
window.addEventListener('message', ev=>{
  const data = ev.data||{};
  if (data.type === 'viewDocument' && data.doc) render(data.doc.content || '');
});

// Boot: localStorage
(function boot(){
  const cached = localStorage.getItem('mdhub:viewDoc');
  if (cached){ try { render(JSON.parse(cached).content || ''); } catch(e){} }
})();
</script>
</body>
</html>
